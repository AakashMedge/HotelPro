generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// TENANT SCHEMA (Hotel Operational Node)
// ==========================================

model User {
  id             String     @id @default(uuid())
  clientId       String     
  username       String     @unique
  name           String
  passwordHash   String
  role           UserRole
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  
  auditLogs      AuditLog[]
  sessions       Session[]
  assignedTables Table[]
  
  // Performance tracking
  totalOrders    Int        @default(0)
  totalSales     Decimal    @default(0.00) @db.Decimal(12, 2)

  @@index([clientId])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// We keep a local Client record to maintain code compatibility
// but it only ever contains 1 row.
model Client {
  id            String       @id @default(uuid())
  name          String
  slug          String       @unique
  domain        String?      @unique
  
  // Reverting to Enums to match generated Prisma client expectations
  plan          ClientPlan   @default(STARTER)
  status        ClientStatus @default(TRIAL)
  isolationLevel IsolationLevel @default(SHARED)
  databaseUrl   String?
  deletedAt     DateTime?
  
  accessCode          String?      @unique
  accessCodeUpdatedAt DateTime?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  tables        Table[]
  categories    Category[]
  menuItems     MenuItem[]
  orders        Order[]
  auditLogs     AuditLog[]
  settings      RestaurantSettings?
  modifierGroups ModifierGroup[]
}

model Table {
  id               String      @id @default(uuid())
  clientId         String
  tableCode        String      
  status           TableStatus @default(VACANT)
  assignedWaiterId String?
  section          String?     
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  deletedAt        DateTime?
  capacity         Int         @default(4)

  client           Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  orders           Order[]
  assignedWaiter   User?       @relation(fields: [assignedWaiterId], references: [id])

  @@unique([clientId, tableCode])
  @@index([clientId])
}

model Category {
  id        String     @id @default(uuid())
  clientId  String
  name      String     
  isActive  Boolean    @default(true)
  sortOrder Int        @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  client    Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  items     MenuItem[]

  @@unique([clientId, name])
  @@index([clientId])
}

model MenuItem {
  id          String  @id @default(uuid())
  clientId    String
  name        String
  description String?
  price       Decimal @db.Decimal(10, 2)
  
  // Happy Hour / Surge Pricing
  specialPrice        Decimal? @db.Decimal(10, 2)
  isSpecialPriceActive Boolean  @default(false)
  specialPriceStart   String?  // e.g. "17:00"
  specialPriceEnd     String?  // e.g. "19:00"

  isAvailable Boolean @default(true)
  isVeg       Boolean @default(true)
  isChefSpecial Boolean @default(false)
  isGlutenFree  Boolean @default(false)

  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  imageUrl    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  client         Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  inventory      Inventory?
  orderItems     OrderItem[]
  variants       MenuItemVariant[]
  modifierGroups MenuItemModifierGroup[]

  @@index([clientId])
}

model MenuItemVariant {
  id         String   @id @default(uuid())
  menuItemId String
  name       String 
  price      Decimal  @db.Decimal(10, 2)
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
}

model ModifierGroup {
  id           String                  @id @default(uuid())
  clientId     String
  name         String 
  isRequired   Boolean                 @default(false)
  minSelection Int                     @default(0)
  maxSelection Int? 

  client       Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  options      ModifierOption[]
  menuItems    MenuItemModifierGroup[]

  @@index([clientId])
}

model ModifierOption {
  id              String        @id @default(uuid())
  modifierGroupId String
  name            String 
  price           Decimal       @default(0.00) @db.Decimal(10, 2)
  isAvailable     Boolean       @default(true)
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
}

model MenuItemModifierGroup {
  id              String @id @default(uuid())
  menuItemId      String
  modifierGroupId String
  displayOrder    Int    @default(0)

  menuItem      MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  modifierGroup ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, modifierGroupId])
}

model Inventory {
  id         String   @id @default(uuid())
  menuItemId String   @unique
  quantity   Int
  updatedAt  DateTime @updatedAt
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])
}

model RestaurantSettings {
  id                  String   @id @default(uuid())
  clientId            String   @unique
  businessName        String   @default("HotelPro Royal")
  gstin               String?  
  gstRate             Decimal  @default(5.0) @db.Decimal(5, 2) 
  serviceChargeRate   Decimal  @default(5.0) @db.Decimal(5, 2) 
  currency            String   @default("INR")
  currencySymbol      String   @default("₹")
  
  primaryColor        String   @default("#0F172A")
  secondaryColor      String   @default("#3B82F6")
  logoUrl             String?
  bannerUrl           String?
  brandTagline        String?
  showBranding        Boolean  @default(true) 
  
  updatedAt           DateTime @updatedAt

  client               Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model Order {
  id           String      @id @default(uuid())
  clientId     String
  tableId      String
  status       OrderStatus @default(NEW)
  version      Int         @default(1)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  closedAt     DateTime?
  customerName String?
  customerPhone String?
  sessionId    String?
  
  subtotal              Decimal?  @db.Decimal(10, 2)
  gstAmount             Decimal?  @db.Decimal(10, 2)
  serviceChargeAmount   Decimal?  @db.Decimal(10, 2)
  grandTotal            Decimal?  @db.Decimal(10, 2)
  appliedGstRate        Decimal?  @db.Decimal(5, 2)  
  appliedServiceRate    Decimal?  @db.Decimal(5, 2)  
  
  client       Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  table        Table       @relation(fields: [tableId], references: [id])
  items        OrderItem[]
  payment      Payment?
  auditLogs    AuditLog[]

  @@index([clientId])
  @@index([tableId])
}

model OrderItem {
  id            String          @id @default(uuid())
  orderId       String
  menuItemId    String
  itemName      String
  priceSnapshot Decimal         @db.Decimal(10, 2)
  quantity      Int
  status        OrderItemStatus @default(PENDING)

  selectedVariant   Json? 
  selectedModifiers Json? 
  notes             String? 

  createdAt DateTime @default(now())
  menuItem  MenuItem @relation(fields: [menuItemId], references: [id])
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model Payment {
  id        String        @id @default(uuid())
  orderId   String        @unique
  method    PaymentMethod
  amount    Decimal       @db.Decimal(10, 2)
  status    PaymentStatus @default(PENDING)
  createdAt DateTime      @default(now())
  order     Order         @relation(fields: [orderId], references: [id])
}

model AuditLog {
  id        String      @id @default(uuid())
  clientId  String
  action    AuditAction
  actorId   String?
  orderId   String?
  metadata  Json?
  createdAt DateTime    @default(now())

  client    Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  actor     User?       @relation(fields: [actorId], references: [id])
  order     Order?      @relation(fields: [orderId], references: [id])

  @@index([clientId])
  @@index([actorId])
  @@index([orderId])
}

// ─────────────────────────────────────────────────────────────────────────────
// ENUMS
// ─────────────────────────────────────────────────────────────────────────────

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  WAITER
  KITCHEN
  CASHIER
}

enum TableStatus {
  VACANT
  ACTIVE
  READY
  WAITING_FOR_PAYMENT
  DIRTY
}

enum OrderStatus {
  NEW
  PREPARING
  READY
  SERVED
  BILL_REQUESTED
  CLOSED
  CANCELLED
}

enum OrderItemStatus {
  PENDING
  PREPARING
  READY
  SERVED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  UPI
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum AuditAction {
  ORDER_CREATED
  ITEM_ADDED
  STATUS_CHANGED
  PAYMENT_AUTHORIZED
  ORDER_CLOSED
  ITEM_CANCELLED
  
  // Platform & Security
  LOGIN_SUCCESS
  LOGIN_FAILURE
  CLIENT_CREATED
  PLAN_CHANGED
  UNAUTHORIZED_ACCESS
  SETTING_CHANGED
  SENSITIVE_DELETE
  CLIENT_ARCHIVED

  // Subscription Lifecycle
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_CANCELED
  SUBSCRIPTION_SYNC_SUCCESS
  SUBSCRIPTION_SYNC_FAILURE
}

enum IsolationLevel {
  SHARED
  DEDICATED
}

enum ClientPlan {
  STARTER
  GROWTH
  ELITE
}

enum ClientStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  ARCHIVED
  PROVISIONING
  PROVISIONING_FAILED
  PAST_DUE
  CANCELED
}

model EntitlementSnapshot {
  id                 String   @id @default("singleton")
  planName           String
  subscriptionStatus String
  features           Json     // JSON schema validated at sync time
  limits             Json     // JSON schema validated at sync time
  version            Int      @default(1) // Monotonic counter
  schemaVersion      Int      @default(1) // Protocol version
  graceUntil         DateTime?
  updatedAt          DateTime @updatedAt
}
