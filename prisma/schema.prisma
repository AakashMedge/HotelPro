generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model SuperAdmin {
  id             String     @id @default(uuid())
  email          String     @unique
  name           String
  passwordHash   String
  lastLogin      DateTime?
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model User {
  id             String     @id @default(uuid())
  clientId       String     
  username       String     @unique
  name           String
  passwordHash   String
  role           UserRole
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  
  client         Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  auditLogs      AuditLog[]
  sessions       Session[]
  assignedTables Table[]
  chatMessages   ChatMessage[]
  chatAcks       ChatAck[]
  
  // Performance tracking for Command Center
  totalOrders    Int        @default(0)
  totalSales     Decimal    @default(0.00) @db.Decimal(12, 2)

  @@index([clientId])
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Client {
  id            String       @id @default(uuid())
  name          String
  slug          String       @unique // for subdomain like 'taj'
  domain        String?      @unique // for custom domain
  plan          ClientPlan   @default(STARTER)
  status        ClientStatus @default(TRIAL)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?    // For soft-deletion/archiving

  ownerEmail    String?      // Real owner email for billing
  stripeCustomerId String?   @unique

  saaSPayments  SaaSPayment[]
  subscription   Subscription?
  platformConversations PlatformConversation[]

  // Customer Access: The "Digital Key" for customer entry
  accessCode          String?  @unique // e.g. "ROYAL99", normalized UPPERCASE
  accessCodeUpdatedAt DateTime?

  users         User[]
  tables        Table[]
  categories    Category[]
  menuItems     MenuItem[]
  orders        Order[]
  auditLogs     AuditLog[]
  complaints    CustomerComplaint[]
  feedbacks     CustomerFeedback[]
  settings      RestaurantSettings?
  modifierGroups ModifierGroup[]
  inventories    Inventory[]
  payments       Payment[]
  chatChannels   ChatChannel[]
}

model Table {
  id               String      @id @default(uuid())
  clientId         String
  tableCode        String      
  status           TableStatus @default(VACANT)
  assignedWaiterId String?
  section          String?     // e.g. "Patio", "Main Hall", "VIP"
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  deletedAt        DateTime?
  capacity         Int         @default(4)

  client           Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  orders           Order[]
  assignedWaiter   User?       @relation(fields: [assignedWaiterId], references: [id])

  @@unique([clientId, tableCode])
  @@index([clientId])
}

model Category {
  id        String     @id @default(uuid())
  clientId  String
  name      String     
  isActive  Boolean    @default(true)
  sortOrder Int        @default(0)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  client    Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)
  items     MenuItem[]

  @@unique([clientId, name])
  @@index([clientId])
}

model MenuItem {
  id          String  @id @default(uuid())
  clientId    String
  name        String
  description String?
  price       Decimal @db.Decimal(10, 2) // Base price
  
  // Happy Hour / Surge Pricing
  specialPrice        Decimal? @db.Decimal(10, 2)
  isSpecialPriceActive Boolean  @default(false)
  specialPriceStart   String?  // e.g. "17:00"
  specialPriceEnd     String?  // e.g. "19:00"

  isAvailable Boolean @default(true)
  isVeg       Boolean @default(true)
  isChefSpecial Boolean @default(false)
  isGlutenFree  Boolean @default(false)

  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
  imageUrl    String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  client         Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  inventory      Inventory?
  orderItems     OrderItem[]
  variants       MenuItemVariant[]
  modifierGroups MenuItemModifierGroup[]

  @@index([clientId])
}

model MenuItemVariant {
  id         String   @id @default(uuid())
  menuItemId String
  name       String // e.g. "Half", "Full"
  price      Decimal  @db.Decimal(10, 2)
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
}

model ModifierGroup {
  id           String                  @id @default(uuid())
  clientId     String
  name         String // e.g. "Spiciness", "Add-ons"
  isRequired   Boolean                 @default(false)
  minSelection Int                     @default(0)
  maxSelection Int? // Null means unlimited

  client       Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  options      ModifierOption[]
  menuItems    MenuItemModifierGroup[]

  @@index([clientId])
}

model ModifierOption {
  id              String        @id @default(uuid())
  modifierGroupId String
  name            String // e.g. "Mild", "Extra Cheese"
  price           Decimal       @default(0.00) @db.Decimal(10, 2)
  isAvailable     Boolean       @default(true)
  modifierGroup   ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
}

model MenuItemModifierGroup {
  id              String @id @default(uuid())
  menuItemId      String
  modifierGroupId String
  displayOrder    Int    @default(0)

  menuItem      MenuItem      @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  modifierGroup ModifierGroup @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)

  @@unique([menuItemId, modifierGroupId])
}

model Inventory {
  id         String   @id @default(uuid())
  clientId   String
  menuItemId String   @unique
  quantity   Int
  updatedAt  DateTime @updatedAt
  
  client     Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])

  @@index([clientId])
}

// Restaurant-wide settings for tax and billing configuration
model RestaurantSettings {
  id                  String   @id @default(uuid())
  clientId            String   @unique
  businessName        String   @default("HotelPro Royal")
  gstin               String?  // Tax ID / GSTIN
  gstRate             Decimal  @default(5.0) @db.Decimal(5, 2) // GST percentage
  serviceChargeRate   Decimal  @default(5.0) @db.Decimal(5, 2) // Service charge percentage
  currency            String   @default("INR")
  currencySymbol      String   @default("₹")
  
  // White-Labeling & Branding (Phase 5)
  primaryColor        String   @default("#0F172A") // Default Slate 900
  secondaryColor      String   @default("#3B82F6") // Default Blue 500
  logoUrl             String?
  bannerUrl           String?
  brandTagline        String?
  showBranding        Boolean  @default(true) // Toggle "Powered by HotelPro"
  
  updatedAt           DateTime @updatedAt

  client               Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model Order {
  id           String      @id @default(uuid())
  clientId     String
  tableId      String
  status       OrderStatus @default(NEW)
  version      Int         @default(1)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  closedAt     DateTime?
  customerName String?
  customerPhone String?
  sessionId    String?
  paymentMethod String?   @default("CASH") // CASH, UPI, CARD
  settledById   String?   // The staff who closed the bill
  // Tax & Billing (Strict Alignment)
  subtotal            Decimal? @db.Decimal(10, 2)
  discountAmount      Decimal? @db.Decimal(10, 2)
  gstAmount           Decimal? @db.Decimal(10, 2)
  serviceChargeAmount Decimal? @db.Decimal(10, 2)
  grandTotal          Decimal? @db.Decimal(10, 2)
  appliedGstRate      Decimal? @db.Decimal(5, 2)
  appliedServiceRate  Decimal? @db.Decimal(5, 2)
  
  client       Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  table        Table       @relation(fields: [tableId], references: [id])
  items        OrderItem[]
  payment      Payment?
  auditLogs    AuditLog[]
  complaints   CustomerComplaint[]
  feedbacks    CustomerFeedback[]

  @@index([clientId])
  @@index([tableId])
}

model OrderItem {
  id            String          @id @default(uuid())
  orderId       String
  menuItemId    String
  itemName      String
  priceSnapshot Decimal         @db.Decimal(10, 2)
  quantity      Int
  status        OrderItemStatus @default(PENDING)

  // New flexible fields for complex orders
  selectedVariant   Json? // Stores { name: "Full", price: 280 }
  selectedModifiers Json? // Stores array of { name: "Extra Cheese", price: 50 }
  notes             String? // Special instructions

  createdAt DateTime @default(now())
  menuItem  MenuItem @relation(fields: [menuItemId], references: [id])
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
}

model Payment {
  id        String        @id @default(uuid())
  clientId  String
  orderId   String        @unique
  method    PaymentMethod
  amount    Decimal       @db.Decimal(10, 2)
  status    PaymentStatus @default(PENDING)
  createdAt DateTime      @default(now())

  client    Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  order     Order         @relation(fields: [orderId], references: [id])

  @@index([clientId])
}

model AuditLog {
  id        String      @id @default(uuid())
  clientId  String
  action    AuditAction
  actorId   String?
  orderId   String?
  metadata  Json?
  createdAt DateTime    @default(now())

  client    Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)
  actor     User?       @relation(fields: [actorId], references: [id])
  order     Order?      @relation(fields: [orderId], references: [id])

  @@index([clientId])
  @@index([actorId])
  @@index([orderId])
}

// ─────────────────────────────────────────────────────────────────────────────
// CUSTOMER COMPLAINT & FEEDBACK
// ─────────────────────────────────────────────────────────────────────────────

model CustomerComplaint {
  id             String           @id @default(uuid())
  clientId       String
  orderId        String?
  tableCode      String           // For quick reference
  type           ComplaintType
  description    String?          // Optional customer description
  status         ComplaintStatus  @default(SUBMITTED)
  guestName      String?          // From localStorage
  resolvedById   String?          // Staff who resolved
  resolvedAt     DateTime?
  resolvedNote   String?          // Manager's resolution note
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  client         Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  order          Order?           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  chatMessages   ChatMessage[]

  @@index([clientId])
  @@index([orderId])
}

model CustomerFeedback {
  id             String           @id @default(uuid())
  clientId       String
  orderId        String
  rating         Int              // 1-5 stars
  comment        String?
  guestName      String?
  tableCode      String?
  createdAt      DateTime         @default(now())

  client         Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  order          Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)
  chatMessages   ChatMessage[]

  @@index([clientId])
  @@index([orderId])
}

// ─────────────────────────────────────────────────────────────────────────────
// ENUMS
// ─────────────────────────────────────────────────────────────────────────────

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIALING
  INACTIVE
}

enum ClientPlan {
  STARTER
  GROWTH
  ELITE
}

enum ClientStatus {
  ACTIVE
  SUSPENDED
  TRIAL
  ARCHIVED
  PROVISIONING
  PROVISIONING_FAILED
  PAST_DUE
  CANCELED
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  WAITER
  KITCHEN
  CASHIER
}

enum TableStatus {
  VACANT
  ACTIVE
  READY
  WAITING_FOR_PAYMENT
  DIRTY
}

enum OrderStatus {
  NEW
  PREPARING
  READY
  SERVED
  BILL_REQUESTED
  CLOSED
  CANCELLED // Added for better tracking
}

enum OrderItemStatus {
  PENDING
  PREPARING
  READY
  SERVED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  UPI
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum AuditAction {
  ORDER_CREATED
  ITEM_ADDED
  STATUS_CHANGED
  PAYMENT_AUTHORIZED
  ORDER_CLOSED
  ITEM_CANCELLED
  
  // Customer Feedback & Complaints
  COMPLAINT_RAISED
  COMPLAINT_ACKNOWLEDGED
  COMPLAINT_RESOLVED
  COMPLAINT_DISMISSED
  COMPLAINT_VERIFIED
  FEEDBACK_SUBMITTED

  // Platform & Security
  LOGIN_SUCCESS
  LOGIN_FAILURE
  CLIENT_CREATED
  PLAN_CHANGED
  UNAUTHORIZED_ACCESS
  SETTING_CHANGED
  SENSITIVE_DELETE
  CLIENT_ARCHIVED

  // Subscription Lifecycle
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_UPDATED
  SUBSCRIPTION_CANCELED
  SUBSCRIPTION_SYNC_SUCCESS
  SUBSCRIPTION_SYNC_FAILURE
}

// ─────────────────────────────────────────────────────────────────────────────
// SUBSCRIPTION & PLAN MODELS (Control-Plane Authority)
// ─────────────────────────────────────────────────────────────────────────────

model Plan {
  id             String         @id @default(uuid())
  name           String         @unique  // "Starter", "Growth", etc.
  code           String         @unique  // Maps to codes like "STARTER", "GROWTH", "CUSTOM_LITE"
  price          Decimal        @db.Decimal(10, 2)
  features       Json           // { "ai_assistant": true, "inventory": true, ... }
  limits         Json           // { "tables": 30, "menuItems": 300 }
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  subscriptions  Subscription[]
}

model Subscription {
  id               String             @id @default(uuid())
  clientId         String             @unique
  planId           String
  status           SubscriptionStatus @default(TRIALING)
  version          Int                @default(1) // Monotonic: always increments
  billingCycle     String             @default("MONTHLY")
  startDate        DateTime?          @default(now())
  currentPeriodEnd DateTime?
  graceUntil       DateTime?          // Tenant stays operational until this date
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  client           Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  plan             Plan               @relation(fields: [planId], references: [id])
  audits           SubscriptionAudit[]

  @@index([planId])
}

model SubscriptionAudit {
  id               String       @id @default(uuid())
  subscriptionId   String
  previousPlanId   String?
  newPlanId        String?
  previousStatus   String?
  newStatus        String?
  reason           String?      // "upgrade", "downgrade", "payment_failed", etc.
  metadata         Json?        // Extra context (invoice ID, admin who changed it)
  createdAt        DateTime     @default(now())

  subscription     Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
}

// CHAT & HUB MODELS
// ─────────────────────────────────────────────────────────────────────────────

model ChatChannel {
  id        String   @id @default(uuid())
  clientId  String
  name      String   // e.g. "GENERAL", "SERVICE", "ADMIN"
  type      ChatChannelType @default(GENERAL)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]

  @@unique([clientId, name])
  @@index([clientId])
}

model ChatMessage {
  id              String   @id @default(uuid())
  channelId       String
  senderId        String
  content         String
  severity        MessageSeverity @default(INFO)
  orderId         String?  // Contextual link to an order
  complaintId     String?  // Link to a specific complaint
  feedbackId      String?  // Link to specific feedback
  
  // Attachments (Voice / Image)
  attachmentUrl   String?
  attachmentType  AttachmentType?

  createdAt DateTime @default(now())

  channel   ChatChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  sender    User        @relation(fields: [senderId], references: [id], onDelete: Cascade)
  complaint CustomerComplaint? @relation(fields: [complaintId], references: [id], onDelete: SetNull)
  feedback  CustomerFeedback? @relation(fields: [feedbackId], references: [id], onDelete: SetNull)
  acks      ChatAck[]

  @@index([channelId])
  @@index([senderId])
  @@index([complaintId])
  @@index([feedbackId])
}

model ChatAck {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  createdAt DateTime @default(now())

  message   ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
}

enum ChatChannelType {
  GENERAL
  SERVICE
  ADMIN_ONLY
  CUSTOMER_FEEDBACK
}

enum ComplaintType {
  NOT_RECEIVED
  WRONG_ITEM
  QUALITY_ISSUE
  DELAY
  MISSING_ITEM
  RUDE_SERVICE
  OTHER
}

enum ComplaintStatus {
  SUBMITTED
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
  DISMISSED
  VERIFIED
}

enum MessageSeverity {
  INFO
  WARN
  URGENT
  STOCK_OUT
}

enum AttachmentType {
  IMAGE
  AUDIO
  VIDEO
  FILE
}

// ─────────────────────────────────────────────────────────────────────────────
// PLATFORM CONCIERGE (HQ-TENANT BRIDGE)
// ─────────────────────────────────────────────────────────────────────────────

enum ConversationStatus {
  OPEN
  CLOSED
  ESCALATED
}

enum ConversationPriority {
  LOW
  NORMAL
  HIGH
}

model PlatformConversation {
  id                String               @id @default(uuid())
  clientId          String
  status            ConversationStatus   @default(OPEN)
  priority          ConversationPriority @default(NORMAL)
  planTierSnapshot  String               // STARTER, GROWTH, ELITE
  slaDeadlineAt     DateTime?
  lastMessageAt     DateTime             @default(now())
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  client            Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  messages          PlatformMessage[]

  @@index([clientId])
}

model PlatformMessage {
  id                String               @id @default(uuid())
  conversationId    String
  senderRole        String               // HOTEL_ADMIN, SUPER_ADMIN
  messageContent    String               @db.Text
  isRead            Boolean              @default(false)
  metadataSnapshot  Json?                
  createdAt         DateTime             @default(now())

  conversation      PlatformConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}
model PlatformBroadcast {
  id        String   @id @default(uuid())
  title     String
  content   String
  type      String   @default("ANNOUNCEMENT") // ANNOUNCEMENT, UPDATE, ALERT
  priority  String   @default("MEDIUM")       // LOW, MEDIUM, HIGH
  target    String   @default("ALL")          // ALL, STARTER, GROWTH, ELITE
  sentBy    String   // Admin Name
  createdAt DateTime @default(now())
}
model SaaSPayment {
  id               String   @id @default(uuid())
  clientId         String
  stripeSessionId  String   @unique
  stripePaymentIntentId String?
  amount           Decimal  @db.Decimal(10, 2)
  currency         String   @default("INR")
  status           String   @default("PAID") // PAID, PENDING, FAILED
  plan             String   // e.g. "GROWTH"
  billingCycle     String   @default("MONTHLY")
  paidAt           DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}
